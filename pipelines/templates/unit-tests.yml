jobs:
- job: "Test_${{ parameters.nodeVersion }}"
  displayName: "Run tests on node ${{ parameters.nodeVersion }}"
  pool:
    vmImage: 'ubuntu-16.04'

  steps:
  - task: NodeTool@0
    displayName: 'Use Node ${{ parameters.nodeVersion }}'
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}.x

  - bash: |
      npm ci
      npm run compile
      npm run test:coverage
    displayName: 'Run tests'

  - bash: |
      printenv
    displayName: make sure we're not leaking info

  - ${{ if eq(parameters.nodeVersion, '8') }}:
    - bash: |
        printenv
        cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
      displayName: 'Upload code coverage report'
      env:
        COVERALLS_SERVICE_NAME: "Azure DevOps"
        COVERALLS_REPO_TOKEN: $(COVERALLS_REPO_TOKEN)
